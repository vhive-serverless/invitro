package generator

import (
	"github.com/vhive-serverless/loader/pkg/common"
	"math"
	"testing"
)

func TestWarmStartMatrix(t *testing.T) {
	tests := []struct {
		testName           string
		experimentDuration int
		rpsTarget          float64
		expectedIAT        common.IATArray
		expectedCount      []int
	}{
		{
			testName:           "2min_1rps",
			experimentDuration: 2,
			rpsTarget:          1,
			expectedIAT: []float64{
				// minute 1
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				// minute 2
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
				1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,
			},
			expectedCount: []int{60, 60},
		},
		{
			testName:           "2min_0.5rps",
			experimentDuration: 2,
			rpsTarget:          0.5,
			expectedIAT: []float64{
				// minute 1
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				// minute 2
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
				2000, 2000, 2000, 2000, 2000,
			},
			expectedCount: []int{30, 30},
		},
		{
			testName:           "2min_0.125rps",
			experimentDuration: 2,
			rpsTarget:          0.125,
			expectedIAT: []float64{
				// minute 1
				8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000,
				// minute 2
				8000, 8000, 8000, 8000, 8000, 8000, 8000,
			},
			expectedCount: []int{8, 7},
		},
	}

	epsilon := 0.01

	for _, test := range tests {
		t.Run("warm_start"+test.testName, func(t *testing.T) {
			matrix, minuteCount := GenerateWarmStartFunction(test.experimentDuration, test.rpsTarget)

			if len(matrix) != len(test.expectedIAT) {
				t.Errorf("Unexpected IAT array size - got: %d, expected: %d", len(matrix), len(test.expectedIAT))
			}
			if len(minuteCount) != len(test.expectedCount) {
				t.Errorf("Unexpected count array size - got: %d, expected: %d", len(minuteCount), len(test.expectedCount))
			}

			sum := 0.0
			count := 0
			currentMinute := 0

			for i := 0; i < len(matrix); i++ {
				if math.Abs(matrix[i]-test.expectedIAT[i]) > epsilon {
					t.Error("Unexpected IAT value.")
				}

				sum += matrix[i]
				count++

				if int(sum/60_000) != currentMinute {
					if count != test.expectedCount[currentMinute] {
						t.Error("Unexpected count array value.")
					}

					currentMinute = int(sum / 60_000)
					count = 0
				}
			}
		})
	}
}

func TestColdStartMatrix(t *testing.T) {
	tests := []struct {
		testName           string
		experimentDuration int
		rpsTarget          float64
		cooldownSeconds    int
		expectedIAT        []common.IATArray
		expectedCount      [][]int
	}{
		{
			testName:           "2min_1rps",
			experimentDuration: 2,
			rpsTarget:          1,
			cooldownSeconds:    10,
			expectedIAT: []common.IATArray{
				{10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-1_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-2_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-3_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-4_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-5_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-6_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-7_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-8_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-9_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
			},
			expectedCount: [][]int{
				{6, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
				{7, 6},
			},
		},
		{
			testName:           "1min_0.25rps",
			experimentDuration: 1,
			rpsTarget:          0.25,
			cooldownSeconds:    10,
			expectedIAT: []common.IATArray{
				{12_000, 12_000, 12_000, 12_000, 12_000},
				{-4_000, 12_000, 12_000, 12_000, 12_000, 12_000},
				{-8_000, 12_000, 12_000, 12_000, 12_000, 12_000},
			},
			expectedCount: [][]int{
				{5},
				{6},
				{6},
			},
		},
		{
			testName:           "2min_0.25rps",
			experimentDuration: 2,
			rpsTarget:          0.25,
			cooldownSeconds:    10,
			expectedIAT: []common.IATArray{
				{12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000},
				{-4_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000},
				{-8_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000, 12_000},
			},
			expectedCount: [][]int{
				{5, 5},
				{6, 5},
				{6, 5},
			},
		},
		{
			testName:           "1min_0.33rps",
			experimentDuration: 1,
			rpsTarget:          1.0 / 3,
			cooldownSeconds:    10,
			expectedIAT: []common.IATArray{
				{12_000, 12_000, 12_000, 12_000, 12_000},
				{-3_000, 12_000, 12_000, 12_000, 12_000, 12_000},
				{-6_000, 12_000, 12_000, 12_000, 12_000, 12_000},
				{-9_000, 12_000, 12_000, 12_000, 12_000, 12_000},
			},
			expectedCount: [][]int{
				{5},
				{6},
				{6},
				{6},
			},
		},
		{
			testName:           "1min_5rps",
			experimentDuration: 1,
			rpsTarget:          5,
			cooldownSeconds:    10,
			expectedIAT: []common.IATArray{
				{10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-1_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-1_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-1_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-1_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-1_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-2_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-2_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-2_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-2_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-2_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-3_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-3_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-3_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-3_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-3_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-4_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-4_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-4_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-4_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-4_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-5_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-5_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-5_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-5_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-5_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-6_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-6_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-6_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-6_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-6_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-7_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-7_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-7_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-7_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-7_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-8_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-8_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-8_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-8_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-8_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},

				{-9_000, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-9_200, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-9_400, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-9_600, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
				{-9_800, 10_000, 10_000, 10_000, 10_000, 10_000, 10_000},
			},
			expectedCount: [][]int{
				{6},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},

				{7},
				{7},
				{7},
				{7},
				{7},
			},
		},
		{
			testName:           "1min_5rps_cooldown5s",
			experimentDuration: 1,
			rpsTarget:          5,
			cooldownSeconds:    5,
			expectedIAT: []common.IATArray{
				{5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-200, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-400, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-600, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-800, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},

				{-1_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-1_200, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-1_400, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-1_600, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-1_800, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},

				{-2_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-2_200, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-2_400, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-2_600, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-2_800, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},

				{-3_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-3_200, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-3_400, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-3_600, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-3_800, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},

				{-4_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-4_200, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-4_400, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-4_600, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
				{-4_800, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000, 5_000},
			},
			expectedCount: [][]int{
				{12},
				{13},
				{13},
				{13},
				{13},

				{13},
				{13},
				{13},
				{13},
				{13},

				{13},
				{13},
				{13},
				{13},
				{13},

				{13},
				{13},
				{13},
				{13},
				{13},

				{13},
				{13},
				{13},
				{13},
				{13},
			},
		},
	}

	epsilon := 0.01

	for _, test := range tests {
		t.Run("cold_start"+test.testName, func(t *testing.T) {
			matrix, minuteCounts := GenerateColdStartFunctions(test.experimentDuration, test.rpsTarget, test.cooldownSeconds)

			if len(matrix) != len(test.expectedIAT) {
				t.Errorf("Unexpected number of functions - got: %d, expected: %d", len(matrix), len(test.expectedIAT))
			}
			if len(minuteCounts) != len(test.expectedCount) {
				t.Errorf("Unexpected count array size - got: %d, expected: %d", len(minuteCounts), len(test.expectedCount))
			}

			for fIndex := 0; fIndex < len(matrix); fIndex++ {
				sum := 0.0
				count := 0
				currentMinute := 0

				if len(matrix[fIndex]) != len(test.expectedIAT[fIndex]) {
					t.Errorf("Unexpected length of function %d IAT array - got: %d, expected: %d", fIndex, len(matrix[fIndex]), len(test.expectedIAT[fIndex]))
				}

				for i := 0; i < len(matrix[fIndex]); i++ {
					if math.Abs(matrix[fIndex][i]-test.expectedIAT[fIndex][i]) > epsilon {
						t.Error("Unexpected value.")
					}

					if currentMinute > len(test.expectedCount[fIndex]) {
						t.Errorf("Invalid expected count array size for function with index %d", fIndex)
					}

					if matrix[fIndex][i] >= 0 {
						sum += matrix[fIndex][i]
					}
					count++

					if int(sum/60_000) != currentMinute {
						if count != test.expectedCount[fIndex][currentMinute] {
							t.Error("Unexpected count array value.")
						}

						currentMinute = int(sum / 60_000)
						count = 0
					}
				}
			}
		})
	}
}
